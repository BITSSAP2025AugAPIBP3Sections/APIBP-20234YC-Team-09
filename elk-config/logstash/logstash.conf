input {
  # Accept logs from Filebeat
  beats {
    port => 5044
  }
  
  # Accept logs via TCP (for direct application logging)
  tcp {
    port => 5000
    codec => json
  }
  
  # Accept logs via UDP
  udp {
    port => 5000
    codec => json
  }
  
  # Read application log files directly
  file {
    path => "/logs/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }
  
  # Parse Node.js logs
  if [message] =~ /^(GET|POST|PUT|DELETE|PATCH)/ {
    grok {
      match => { "message" => "%{WORD:http_method} %{URIPATH:request_path} %{NUMBER:status_code:int} - %{NUMBER:response_time:float} ms" }
    }
    mutate {
      add_field => { "log_type" => "api_request" }
    }
  }
  
  # Add timestamp
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
    target => "@timestamp"
  }
  
  # Add application tags
  mutate {
    add_field => {
      "application" => "fusion-electronics"
      "environment" => "development"
    }
  }
  
  # Parse error logs
  if [level] == "error" or [severity] == "error" {
    mutate {
      add_tag => [ "error" ]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "fusion-logs-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "fusionelk123"
  }
  
  # Debug output to console
  stdout {
    codec => rubydebug
  }
}
